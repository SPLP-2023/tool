<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Strike Tools</title>
    <link rel="manifest" href="/tool/manifest.json">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/png" href="./assets/SP%20Bolt%20400x400.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/tool/icons/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/tool/icons/apple-touch-icon-167x167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/tool/icons/apple-touch-icon-152x152.png">
    <meta name="mobile-web-app-capable" content="yes">    
    <meta name="apple-mobile-web-app-title" content="StrikeR">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
</head>
<body>
    <div class="container">
        <!-- Header with Logo -->
        <div class="header-section">
            <img src="./assets/SP%20Bolt%20400x400.png" alt="Strike Point Logo" class="header-logo">
            <h1 class="app-title">Strike Tools</h1>
            <p class="app-subtitle">Lightning Protection Engineering Solutions</p>
        </div>

        <!-- Login Section -->
        <div class="login-section">
            <div class="login-card">
                <div class="login-icon">üîê</div>
                <h2>Access Required</h2>
                <p>Please login with your authorized GitHub account to access Strike Tools</p>
                <button id="githubLoginBtn" class="github-login-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"/>
                    </svg>
                    Login with GitHub
                </button>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-section">
            <p>Strike Point Lightning Protection Ltd</p>
            <p>Professional Lightning Protection Solutions</p>
        </div>
    </div>

    <style>
        .header-section {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
        }

        .header-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
        }

        .app-title {
            font-size: 48px;
            color: white;
            margin: 0;
            font-weight: bold;
        }

        .app-subtitle {
            font-size: 18px;
            color: #2980c9;
            margin: 10px 0 0 0;
        }

        .login-section {
            display: flex;
            justify-content: center;
            margin: 40px 0;
        }

        .login-card {
            background: #fff;
            border: 2px solid #2980c9;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }

        .login-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .login-card h2 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            font-size: 28px;
        }

        .login-card p {
            color: #7f8c8d;
            margin: 0 0 30px 0;
            font-size: 16px;
            line-height: 1.4;
        }

        .github-login-btn {
            background: linear-gradient(135deg, #24292e 0%, #0366d6 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .github-login-btn:hover {
            background: linear-gradient(135deg, #0366d6 0%, #24292e 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .error-message {
            color: #e74c3c;
            background: #fdf2f2;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin-top: 15px;
            font-size: 14px;
        }

        .footer-section {
            text-align: center;
            margin-top: 60px;
            padding: 20px 0;
            color: #7f8c8d;
        }

        .footer-section p {
            margin: 5px 0;
            font-size: 14px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .app-title {
                font-size: 36px;
            }
            
            .login-card {
                margin: 0 20px;
                padding: 30px 20px;
            }
            
            .login-card h2 {
                font-size: 24px;
            }
        }
    </style>

    <script>
        // GitHub OAuth configuration
        const CLIENT_ID = 'Ov23liaNOKH2tYrXZ9yx';
        const REDIRECT_URI = 'https://SPLP-2023.github.io/tool/login.html';
        const AUTHORIZED_USERS = ['SPLP-2023', 'LK-SPLP', 'JB-SPLP']; // Authorized GitHub usernames

        // Check if user is already logged in
        function checkExistingAuth() {
            const token = localStorage.getItem('github_token');
            const user = localStorage.getItem('github_user');
            
            if (token && user && AUTHORIZED_USERS.includes(user)) {
                // User is already authenticated, redirect to main app
                window.location.href = 'index.html';
                return;
            }
        }

        // Handle GitHub OAuth login
        function initiateGitHubLogin() {
            const state = Math.random().toString(36).substring(7);
            localStorage.setItem('oauth_state', state);
            
            const githubUrl = `https://github.com/login/oauth/authorize?` +
                `client_id=${CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
                `scope=user&` +
                `state=${state}`;
            
            window.location.href = githubUrl;
        }

        // Handle OAuth callback
        async function handleOAuthCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const storedState = localStorage.getItem('oauth_state');

            if (!code) return;

            // Verify state parameter
            if (state !== storedState) {
                showError('Security error: Invalid state parameter');
                return;
            }

            localStorage.removeItem('oauth_state');

            try {
                // Exchange code for access token using GitHub's client-side flow
                const tokenResponse = await fetch(`https://github.com/login/oauth/access_token`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        client_id: CLIENT_ID,
                        code: code,
                    })
                });

                const tokenData = await tokenResponse.json();

                if (tokenData.access_token) {
                    // Get user information
                    const userResponse = await fetch('https://api.github.com/user', {
                        headers: {
                            'Authorization': `token ${tokenData.access_token}`
                        }
                    });

                    const userData = await userResponse.json();

                    if (AUTHORIZED_USERS.includes(userData.login)) {
                        // User is authorized, store credentials
                        localStorage.setItem('github_token', tokenData.access_token);
                        localStorage.setItem('github_user', userData.login);
                        
                        // Redirect to main application
                        window.location.href = 'index.html';
                    } else {
                        showError(`Access denied: ${userData.login} is not an authorized user`);
                    }
                } else {
                    showError('Authentication failed: Unable to obtain access token');
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showError('Authentication failed: Please try again');
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already authenticated
            checkExistingAuth();
            
            // Handle OAuth callback
            handleOAuthCallback();
            
            // Add click handler for login button
            document.getElementById('githubLoginBtn').addEventListener('click', initiateGitHubLogin);
        });
    </script>
</body>
</html>
